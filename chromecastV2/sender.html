<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Creative - Start Bootstrap Theme</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- Custom fonts for this template -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>

    <!-- Plugin CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">
    <style>
      /* override receiver's font size */
      div#wrap pre {
        font-size:14px;
        padding: 4px;
      }
    </style>

  </head>

  <body id="page-top">

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">CastAway V2.0</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link rc-js-scroll-trigger" href="#search">Search</a>
            </li>
            <li class="nav-item">
              <a class="nav-link rc-js-scroll-trigger" href="#listing">Version Listing</a>
            </li>
            <li class="nav-item">
              <a class="nav-link rc-js-scroll-trigger" href="#chords">Chords</a>
            </li>
            <li class="nav-item">
              <a class="nav-link rc-js-scroll-trigger" href="#debugsection">Debug</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <header class="masthead text-center text-white d-flex">
      <div class="container my-auto">
        <div class="row">
          <div class="col-lg-10 mx-auto">
            <h1 class="text-uppercase">
              <strong id="cast_setup_title">Hang On a Moment</strong>
            </h1>
            <hr>
          </div>
          <div class="col-lg-8 mx-auto">
            <p id="cast_setup_body" class="text-faded mb-5">
            Waiting for ChromeCast Device availability ...
            </p>
            <p class="text-faded mb-5">
            Start Bootstrap can help you build better websites using the Bootstrap CSS framework! Just download your template and start going, no strings attached!
            </p>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-8 mx-auto">
            <a id="cast_btn" class="none btn btn-primary btn-xl" >Cast this baby!</a>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-8 mx-auto">
            <a id="stop_cast_btn" class="none btn btn-primary btn-xl" >End Casting</a>
          </div>
        </div>
      </div>
    </header>

    <section id="services" class='none'>
      <div class="container">
        <div class="row">
          <div class="col-lg-12 text-center">
            <h2 class="section-heading">At Your Service</h2>
            <hr class="my-4">
          </div>
        </div>
      </div>
      <div class="container">
        <div class="row">
          <div class="col-lg-3 col-md-6 text-center">
            <div class="service-box mt-5 mx-auto">
              <i class="fa fa-4x fa-diamond text-primary mb-3 sr-icons"></i>
              <h3 class="mb-3">Sturdy Templates</h3>
              <p class="text-muted mb-0">Our templates are updated regularly so they don't break.</p>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 text-center">
            <div class="service-box mt-5 mx-auto">
              <i class="fa fa-4x fa-paper-plane text-primary mb-3 sr-icons"></i>
              <h3 class="mb-3">Ready to Ship</h3>
              <p class="text-muted mb-0">You can use this theme as is, or you can make changes!</p>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 text-center">
            <div class="service-box mt-5 mx-auto">
              <i class="fa fa-4x fa-newspaper-o text-primary mb-3 sr-icons"></i>
              <h3 class="mb-3">Up to Date</h3>
              <p class="text-muted mb-0">We update dependencies to keep things fresh.</p>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 text-center">
            <div class="service-box mt-5 mx-auto">
              <i class="fa fa-4x fa-heart text-primary mb-3 sr-icons"></i>
              <h3 class="mb-3">Made with Love</h3>
              <p class="text-muted mb-0">You have to make your websites with love these days!</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="none p-0" id="portfolio">
      <div class="container-fluid p-0">
        <div class="row no-gutters popup-gallery">
          <div class="col-lg-4 col-sm-6">
            <a class="portfolio-box" href="img/portfolio/fullsize/1.jpg">
              <img class="img-fluid" src="img/portfolio/thumbnails/1.jpg" alt="">
              <div class="portfolio-box-caption">
                <div class="portfolio-box-caption-content">
                  <div class="project-category text-faded">
                    Category
                  </div>
                  <div class="project-name">
                    Project Name
                  </div>
                </div>
              </div>
            </a>
          </div>
          <div class="col-lg-4 col-sm-6">
            <a class="portfolio-box" href="img/portfolio/fullsize/2.jpg">
              <img class="img-fluid" src="img/portfolio/thumbnails/2.jpg" alt="">
              <div class="portfolio-box-caption">
                <div class="portfolio-box-caption-content">
                  <div class="project-category text-faded">
                    Category
                  </div>
                  <div class="project-name">
                    Project Name
                  </div>
                </div>
              </div>
            </a>
          </div>
          <div class="col-lg-4 col-sm-6">
            <a class="portfolio-box" href="img/portfolio/fullsize/3.jpg">
              <img class="img-fluid" src="img/portfolio/thumbnails/3.jpg" alt="">
              <div class="portfolio-box-caption">
                <div class="portfolio-box-caption-content">
                  <div class="project-category text-faded">
                    Category
                  </div>
                  <div class="project-name">
                    Project Name
                  </div>
                </div>
              </div>
            </a>
          </div>
          <div class="col-lg-4 col-sm-6">
            <a class="portfolio-box" href="img/portfolio/fullsize/4.jpg">
              <img class="img-fluid" src="img/portfolio/thumbnails/4.jpg" alt="">
              <div class="portfolio-box-caption">
                <div class="portfolio-box-caption-content">
                  <div class="project-category text-faded">
                    Category
                  </div>
                  <div class="project-name">
                    Project Name
                  </div>
                </div>
              </div>
            </a>
          </div>
          <div class="col-lg-4 col-sm-6">
            <a class="portfolio-box" href="img/portfolio/fullsize/5.jpg">
              <img class="img-fluid" src="img/portfolio/thumbnails/5.jpg" alt="">
              <div class="portfolio-box-caption">
                <div class="portfolio-box-caption-content">
                  <div class="project-category text-faded">
                    Category
                  </div>
                  <div class="project-name">
                    Project Name
                  </div>
                </div>
              </div>
            </a>
          </div>
          <div class="col-lg-4 col-sm-6">
            <a class="portfolio-box" href="img/portfolio/fullsize/6.jpg">
              <img class="img-fluid" src="img/portfolio/thumbnails/6.jpg" alt="">
              <div class="portfolio-box-caption">
                <div class="portfolio-box-caption-content">
                  <div class="project-category text-faded">
                    Category
                  </div>
                  <div class="project-name">
                    Project Name
                  </div>
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>
    </section>

    <section id="search" class="bg-dark text-white">
      <div class="container text-center">
        <h2 class="mb-4">Search for Chords</h2>

        <div class="row">

          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="basic-addon1">Title:</span>
            </div>
            <input id="title" type="text" class="form-control" placeholder="Title" aria-label="Title" aria-describedby="basic-addon1">
          </div>

          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="basic-addon1">Artist:</span>
            </div>
            <input id="artist" type="text" class="form-control" placeholder="Artist" aria-label="Artist" aria-describedby="basic-addon1">
          </div>
        </div>


        <a id="search_btn"class="btn btn-primary btn-xl sr-button" >Search!</a>

        <!--
        <button id="search_result" class='btn btn-primary'></button>
        -->


      </div>
    </section>

    <section id="listing">
      <div class="container">
        <div class="row">
          <div class="col-lg-12 ml-auto text-center">
            <h5 id="titleName">title:</h5> by <h5 id="artistName">artist:</h5>
          </div>
        </div>

        <div class="controlBtns row none">
          <div class="col-lg-4 mx-auto text-center">
            <a id="trim_btn" class="btn btn-primary btn-xl" >Trim Top Lines</a>
          </div>
          <div class="col-lg-4 mx-auto text-center">
            <a data-dir="up" class="btn transpose btn-primary btn-xl" >Transpose Up</a>
          </div>
          <div class="col-lg-4 mx-auto text-center">
            <a data-dir="down" class="btn transpose btn-primary btn-xl" >Transpose Down</a>
          </div>
        </div>
        <div id="rec_list_container">
        </div>

      </div>
    </section>

    <section id="chords">
      <div id="wrap" style="padding: 12px;">
      </div>
    </section>

    <section class="bg-primary" id="debugsection">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mx-auto text-center">
            <h2 class="section-heading">Debug Section:</h2>
            <hr class="my-4">
            <div class="mb-5" id="debug">
            </div>
            <hr class="my-4">
          </div>
        </div>
        <div class="row">
          <div class="col-lg-8 mx-auto text-center">
            <h2 class="section-heading text-white">We've got what you need!</h2>
            <hr class="light my-4">
            <p class="text-faded mb-4">Start Bootstrap has everything you need to get your new website up and running in no time! All of the templates and themes on Start Bootstrap are open source, free to download, and easy to use. No strings attached!</p>
            <a class="btn btn-light btn-xl js-scroll-trigger" href="#services">Get Started!</a>
          </div>
        </div>
      </div>
    </section>


    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.20.0.min.js"></script>

    <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>


    <!-- Bootstrap core JavaScript -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script> 
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js" integrity="sha384-feJI7QwhOS+hwpX2zkaeJQjeiwlhOP+SdQDqhgvvo1DsjtiSQByFdThsxO669S2D" crossorigin="anonymous"></script>

    <!-- Plugin JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js"></script>
    <!--
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.compatibility.min.js"></script>
    -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/scrollReveal.js/3.3.6/scrollreveal.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/common.js"></script>
    <script type="text/javascript">
      var applicationID = '6DA08A38';
      var namespace = 'urn:x-cast:com.google.cast.sample.castaway';
      var session = null;

      /**
       * initialization
       */
      function initializeCastApi() {
      	log("initializing cast api");
        var sessionRequest = new chrome.cast.SessionRequest(applicationID);
        var apiConfig = new chrome.cast.ApiConfig(sessionRequest, sessionListener, receiverListener); 
        chrome.cast.initialize(apiConfig, onInitSuccess, onError);
      }

      /**
       * initialization success callback
       */
      function onInitSuccess() {
        log('onInitSuccess');
      }

      /**
       * initialization error callback
       */
      function onError(message) {
        log('onError');
        log(message);
      }

      /**
       * generic success callback
       */
      function onSuccess(message) {
        log('onSuccess: ' + message);
      }

      /**
       * callback on success for stopping app
       */
      function onStopAppSuccess() {
        log('onStopAppSuccess');
  	    $("#cast_btn").show();
  	    $("#stop_cast_btn").hide();
      }

      /**
       * session listener during initialization
       */
      function sessionListener(e) {
        log('New session ID:' + e.sessionId);
        session = e;
        session.addUpdateListener(sessionUpdateListener);
        session.addMessageListener(namespace, receiverMessage);
  	    $("#cast_btn").hide();
  	    $("#stop_cast_btn").fadeIn();
      }

      /**
       * listener for session updates
       */
      function sessionUpdateListener(isAlive) {
        var message = isAlive ? 'Session Updated' : 'Session Removed';
        message += ': ' + session.sessionId;
        log(message);
        if (!isAlive) {
          session = null;
          log("re-display cast btn");
          $("#cast_btn").fadeIn();
        }
      }

      /**
       * utility function to log messages from the receiver
       * @param {string} namespace The namespace of the message
       * @param {string} message A message string
       */
      function receiverMessage(namespace, message) {
        log('receiverMessage: ' + namespace + ', ' + message);
      }

      /**
       * receiver listener during initialization
       */
      function receiverListener(e) {
      	log("Receiver Listener Event:" + e);
      	switch(e){
          case 'available':
            $("#cast_setup_title").text(e);
            $("#cast_setup_body").text("Found chrome cast device.");
            $("#cast_btn").fadeIn();
            break;
          case 'unavailable':
            $("#cast_setup_title").text(e);
            //$("#cast_setup_title").text("Nope!");
            $("#cast_setup_body").text("No chrome cast devices found on the network.");
            break;
          default:
            $("#cast_setup_title").text(e);
            //$("#cast_setup_title").text("Nope!");
            //$("#cast_setup_body").text("No chrome cast devices found on the network.");
            break;
        }
        console.log("e",e);
      }

      /**
       * stop app/session
       */
      function stopApp() {
        $("#cast_setup_title").text("Ending Session");
        $("#cast_setup_body").text("......");
        session.stop(onStopAppSuccess, onError);
      }

      /**
       * send a message to the receiver using the custom namespace
       * receiver CastMessageBus message handler will be invoked
       * @param {string} message A message string
       */
      function sendMessage(message) {

        if (session != null) {
        	log("session not null");
          session.sendMessage(namespace, message, onSuccess.bind(this, 'Message sent: ' + message), onError);
        }
        else {
        	log("session was null, requesting cast session");
        	log("requesting cast session");
          chrome.cast.requestSession(function(e) {
          	log(" requestSession callback ");
  	        $("#cast_btn").hide();
  	        $("#stop_cast_btn").fadeIn();
            session = e;
            session.addMessageListener(namespace, receiverMessage);
            session.sendMessage(
              namespace, 
              message, 
              onSuccess.bind(this, 'Message sent: ' + message), 
              function(err){
                log(" got err in sendMessage callback:");
                log(err);
              }
            );

          }, function(rErr){
              log("got err in requestSession callback:");
              log(rErr);
          });
        }
      }

      /**
       * append message to debug message window
       * @param {string} message A message string
       */
      function log(message) {
        console.log(message);
        $("#debug").append("<div>"+ JSON.stringify(message) + "</div>" );
      }

      /**
       * utility function to handle text typed in by user in the input field
       */
      function update() {
      	console.log("update event");
        log("Attemtping Cast"); 
        sendMessage("setup")
      }

      /**
       * handler for the transcribed text from the speech input
       * @param {string} words A transcibed speech string
       */
      function transcribe(words) {
        sendMessage(words);
      }
      
      function checkForCastAPI(){
        console.log(chrome.cast);
        console.log(chrome.cast.isAvailable);
        console.log(chrome.cast , chrome.cast.isAvailable);
        if (chrome.cast && chrome.cast.isAvailable) {
          return setTimeout(initializeCastApi, 1000);
        }

        log("chromecast API not available.");
        return setTimeout(checkForCastAPI,1000);
      }

      $(document).ready(function(){


        xApp.recordSelected_new = function(e){
          var ug_url = $(this).data("info").url;
          return sendMessage("xApp.ajaxChords:" + ug_url);
        };

        xApp.recordSelected = function(e){

          var ug_url = $(this).data("info").url;
          if ( xApp.versions[ug_url]!== undefined){
            return xApp.formatChords(xApp.versions[ug_url]) ;
          }

          var url = "https://us-central1-castaway-191110.cloudfunctions.net/song";
          //$("#recList").hide();
          $.post(url,{ug_url: ug_url},function(result){
            console.log(result);
            return xApp.ajaxChords(ug_url,function(ph){
              xApp.versions[ug_url] = ph;
            });
          })
          .fail(function(err){
            log("failed ajaxSearch");
            console.error("fn_search");
            console.error(err);
          })
        };
        xApp.storeVersion = function(ph){
            xApp.versions
        }
        xApp.toggleReclist = function(){
        	$("#recList").toggle();
        }
        xApp.transpose = function(dir){
          xApp.pubnub.publish(
            {
                message: {
                  kind:"transpose",
                  dir: dir,
                  steps: 1
                },
                channel: 'castaway',
                sendByPost: false, // true to send via post
                storeInHistory: false, //override default storage options
            },
            function (status, response) {
                // handle status, response
            }
          );
          
        },
        xApp.initPubNub = function(){
          xApp.pubnub = new PubNub({
            subscribeKey: 'sub-b8449342-0962-11e1-bec7-05a8a56cd07c', // always required
            publishKey: 'pub-4f2959b6-ad9f-4c3a-a7d6-39aa4232d153' // only required if publishing
          });

          xApp.pubnub.addListener({
            status: function(se){  
              console.log('se');
              console.log(se);
              $("#titleRight").text(se.category);
            },
            message: function(msg){
              log("got pubnub msg")
              $("#titleLeft").text("Received message from PubNub");
              log(msg);
              msg = msg.message;
              switch(msg.kind){
                case "search": 
                  // to notify sender that a search was done via alexa, 
                  if (typeof xApp.ajaxSearch==='function'){
                    $("#artist").val(msg.artist);
                    $("#title").val(msg.title);
                    return //xApp.ajaxSearch();
                  }
                   
                  return; 
                case "chords": 
                  console.log("sender recieved 'chords' event from pubnub");
                  $(".controlBtns").show();
                  return;
                  $("#titleRight").text(msg.pathToChords);
                  console.log("got path:"+msg.pathToChords);
                  return xApp.ajaxChords(msg.pathToChords);
                case "state":
                  return xApp.loadMsg(msg.txt);
                case "transpose":
                  //for receiver, sender doesn't do anything
                  return ;
                default:
                          
                  break;
              }
            }
          });
          xApp.pubnub.subscribe({ channels: ['castaway'] });
        }
       
        xApp.ajaxSearch = function(){
          xApp.versions = {};
        	var artist = $("#artist").val();
        	var title = $("#title").val();

          $("#artistName").text(artist);
          $("#titleName").text(title);

          var url = "https://us-central1-castaway-191110.cloudfunctions.net/search";
          console.log(artist,title,url);
          //$("#search_btn").hide();
          $("#rec_list_container").html("");
          $.post(url,{artist:artist,title:title,allResults:true,userId:"rie"},function(result){
            console.log(result); 
            var recList = $("<div class='d-flex flex-wrap flex-row' id='recList'></div>")
            result.recs.sort(function(a,b){ if(a.rating<b.rating)return 1; else return -1;}).forEach(function(r,idx){
              var rec = $("<div class='rec p-4' style='cursor: pointer;margin-bottom: 16px;'>Ver " + (idx+1) + " (" + r.rating + ")</div>");
              rec.data('info',r);
              recList.append(rec);
            })

            $("#rec_list_container").html(recList);
            $("#recList div").unbind("click").bind("click",xApp.recordSelected);
            xApp.scrollTo("rec_list_container");

            return;
            $("#search_result").text("Found " + result.recs.length + " versions.")
            .unbind("click").bind("click",xApp.toggleReclist);
            $("#search_btn").show();
          })
          .fail(function(err){
            log("failed ajaxSearch");
            console.error("fn_search");
            console.error(err);
          })
        }

  	    xApp.initPubNub();
      	console.log("ready");
  	    log("document ready");
  	    //update();
  	    $("#cast_btn").bind("click",function(){
          log("triggering setup "); 
          return sendMessage("setup")
  	    })

  	    $("#stop_cast_btn").bind("click",function(){
          log("triggering stop cast"); 
          //$(this).hide();
          return session.stop(onStopAppSuccess, onError);
  	    })

  	    $("#search_btn").bind("click",function(){
          xApp.ajaxSearch();
  	    })
  	    $("#test_btn").bind("click",function(){
          xApp.publish();
  	    })
  	    $(".btn.transpose").bind("click",function(){
  	    	var dir = $(this).data("dir")
  	    	console.log(dir);
          xApp.transpose( dir );
  	    })
        $("#trim_btn").bind("click", function(){
        	 xApp.removeTopLines(5);
        });

        // send scroll message to receiver
        $('a.rc-js-scroll-trigger[href*="#"]:not([href="#"])').click(function() {
          log("rc scroll triggerred");
          var scrollTarget = $(this).attr("href").substr(1);
          log(scrollTarget);

          return sendMessage("xApp.scrollTo:" + scrollTarget);
        });

        /**
         * Call initialization for Cast
         */
        setTimeout(checkForCastAPI,2000);
      })

    </script>

  </body>

</html>
