<html>
  <head>
    <link href="style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
    <title>Cast Sender App</title>
  </head>
  <body>
    <a id="cast_btn" style="padding:20px;cursor:pointer;border:2px solid #fff;color:yellow; font-size:32px">CAST THIS</a>
    <div class="title left" id="titleLeft">KLeft</div>
    <div class="title right" id="titleRight">Right</div>
    <div id="stateDiv" style='width:96%'>
      CastAway Sender
    </div>

    <div id="wrap" class="sender"></div>
    <div id="debug" style="color:#fff"></div>
    <div style="clear:both"></div>


    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.20.0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script> 

    <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
    <script src="https://storage.googleapis.com/castaway/common.js"></script>

    <script type="text/javascript">
      var applicationID = '6DA08A38';
      var namespace = 'urn:x-cast:com.google.cast.sample.castaway';
      var session = null;


      /**
       * initialization
       */
      function initializeCastApi() {
      	log("initializing cast api");
        var sessionRequest = new chrome.cast.SessionRequest(applicationID);
        var apiConfig = new chrome.cast.ApiConfig(sessionRequest, sessionListener, receiverListener); 
        chrome.cast.initialize(apiConfig, onInitSuccess, onError);
      }

      /**
       * initialization success callback
       */
      function onInitSuccess() {
        log('onInitSuccess');
      }

      /**
       * initialization error callback
       */
      function onError(message) {
        log('onError');
        log(message);
      }

      /**
       * generic success callback
       */
      function onSuccess(message) {
        log('onSuccess: ' + message);
      }

      /**
       * callback on success for stopping app
       */
      function onStopAppSuccess() {
        log('onStopAppSuccess');
      }

      /**
       * session listener during initialization
       */
      function sessionListener(e) {
        log('New session ID:' + e.sessionId);
        session = e;
        session.addUpdateListener(sessionUpdateListener);
        session.addMessageListener(namespace, receiverMessage);
      }

      /**
       * listener for session updates
       */
      function sessionUpdateListener(isAlive) {
        var message = isAlive ? 'Session Updated' : 'Session Removed';
        message += ': ' + session.sessionId;
        log(message);
        if (!isAlive) {
          session = null;
        }
      }

      /**
       * utility function to log messages from the receiver
       * @param {string} namespace The namespace of the message
       * @param {string} message A message string
       */
      function receiverMessage(namespace, message) {
        log('receiverMessage: ' + namespace + ', ' + message);
      }

      /**
       * receiver listener during initialization
       */
      function receiverListener(e) {
        if(e === 'available') {
          log('receiver found');
        }
        else {
          log('receiver list empty');
        }
        console.log(e);
      }

      /**
       * stop app/session
       */
      function stopApp() {
        session.stop(onStopAppSuccess, onError);
      }

      /**
       * send a message to the receiver using the custom namespace
       * receiver CastMessageBus message handler will be invoked
       * @param {string} message A message string
       */
      function sendMessage(message) {

        if (session != null) {
        	log("session not null");
          session.sendMessage(namespace, message, onSuccess.bind(this, 'Message sent: ' + message), onError);
        }
        else {
        	log("session was null, requesting cast session");
        	log("requesting cast session");
          chrome.cast.requestSession(function(e) {
              session = e;
              session.sendMessage(namespace, message, onSuccess.bind(this, 'Message sent: ' +
                message), onError);
            }, onError);
        }
      }

      /**
       * append message to debug message window
       * @param {string} message A message string
       */
      function log(message) {
        console.log(message);
        $("#debug").append("<div>"+ JSON.stringify(message) + "</div>" );
      }

      /**
       * utility function to handle text typed in by user in the input field
       */
      function update() {
      	console.log("update event");
        log("Attemtping Cast"); 
        sendMessage("setup")
      }

      /**
       * handler for the transcribed text from the speech input
       * @param {string} words A transcibed speech string
       */
      function transcribe(words) {
        sendMessage(words);
      }

      $(document).ready(function(){
      	console.log("ready");
  	    xApp.initPubNub();
  	    log("document ready");
  	    //update();
  	    log( $("#cast_btn").length );
  	    $("#cast_btn").bind("click",function(){
            log("got click"); 
            update();
  	    })
  	    $("#cast_btn").bind("tap",function(){
            log("got tap"); 
  	    })
        /**
         * Call initialization for Cast
         */
        if (!chrome.cast || !chrome.cast.isAvailable) {
          setTimeout(initializeCastApi, 1000);
        }
      })

    </script>
  </body>
</html>
